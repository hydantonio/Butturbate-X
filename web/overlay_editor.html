
<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Overlay Editor</title>
<style>
  html,body{height:100%;margin:0;background:transparent;font:14px/1.5 Inter,system-ui,Segoe UI,Roboto,Calibri,sans-serif;color:#fff;overflow:hidden}
  .stage{ width:1920px; height:1080px; position:relative; overflow:hidden; margin:0 auto; }
  .grid{ position:absolute; inset:0; background-image: radial-gradient(circle at 10px 10px, rgba(170,180,200,.12) 1px, transparent 1px); background-size:20px 20px; pointer-events:none; }
  .vignette{position:absolute;inset:0;background:radial-gradient(80% 60% at 50% 50%, transparent 60%, rgba(0,0,0,.35));mix-blend:normal;pointer-events:none;}
  .glow{ position:absolute; inset:0; background: radial-gradient(600px 300px at 18% 18%, rgba(255,122,200,.18), transparent 55%), radial-gradient(600px 300px at 82% 34%, rgba(154,216,255,.18), transparent 55%); pointer-events:none; mix-blend:screen; }
  .canvas-abs{ position:absolute; inset:0; }
  .element{ position:absolute; user-select:none; touch-action:none; border-radius:16px; overflow:hidden; display:flex; align-items:center; justify-content:center; text-shadow:0 2px 6px rgba(0,0,0,.35); background:rgba(255,255,255,.06); color:#fff; padding:12px 16px; backdrop-filter: blur(6px); box-shadow: 0 10px 30px rgba(0,0,0,.25); border: 1px solid rgba(255,255,255,.08); }
  .goalbar{ background: rgba(255,255,255,.06); border-radius:18px; border:1px solid rgba(255,255,255,.1); position:absolute; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(0,0,0,.2), 0 10px 30px rgba(0,0,0,.25); }
  .goalbar .fill{ position:absolute; left:0; top:0; bottom:0; width:0%; background: linear-gradient(90deg,#ff7ac8,#9ad8ff); box-shadow: 0 10px 30px rgba(120,60,140,.18) inset; transition: width .25s ease; }
  .goalbar .label{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; text-shadow:0 2px 6px rgba(0,0,0,.35); }
  .pill{ background: linear-gradient(90deg, #ff7ac8, #9ad8ff); color:#0a0d14; font-weight:900; border-radius:999px; box-shadow: 0 10px 30px rgba(120,60,140,.18); }
  .alert{ position:absolute; padding:14px 18px; border-radius:14px; font-weight:900; background:rgba(20,24,32,.9); color:#fff; border:1px solid rgba(255,255,255,.1); box-shadow:0 20px 60px rgba(0,0,0,.35); }
  .ring{ position:absolute; display:flex; align-items:center; justify-content:center; border-radius:50%; width:180px; height:180px; }
  .ring .arc{ position:absolute; inset:0; border-radius:50%; mask: radial-gradient(circle at center, transparent 55%, black 56%); background: conic-gradient(#ff7ac8 var(--p,0%), #9ad8ff 0); }
  .ring .label{ position:relative; font-weight:900; text-shadow:0 2px 6px rgba(0,0,0,.4); }
  .ticker{ position:absolute; white-space:nowrap; will-change: transform; animation: marquee var(--spd,20s) linear infinite; }
  @keyframes marquee { from{ transform: translateX(100%);} to{ transform: translateX(-100%);} }
  .countdown{ position:absolute; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px 14px; font-weight:900; }
  .handle{position:absolute;width:12px;height:12px;border-radius:50%;background:#fff;border:2px solid #9ab6ff;box-shadow:0 2px 6px rgba(0,0,0,.25);cursor:nwse-resize;right:-6px;bottom:-6px;}
</style>
</head>
<body>
  <div class="stage">
    <div class="grid" id="grid"></div>
    <div class="glow"></div>
    <div class="vignette"></div>
    <div class="canvas-abs" id="canvas"></div>
  </div>

<script>
(function(){
  const stage = document.querySelector('.stage');
  const grid = document.getElementById('grid');
  const canvas = document.getElementById('canvas');
  let editing = true;
  let sel = null;
  let GRID = 20;

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const snap = (n)=> Math.round(n/GRID)*GRID;
  const post = (msg)=> parent.postMessage(msg,'*');

  addEventListener('load', ()=> post({type:'editor:hello'}));

  function select(el){
    sel = el; if(!sel) return; post({type:'editor:select', id: el.id, left: el.offsetLeft, top: el.offsetTop, width: el.offsetWidth, height: el.offsetHeight, z:+(el.style.zIndex||0), rotate:+(el.dataset.rotate||0), opacity:+(el.style.opacity||1)});
    let h = sel.querySelector(':scope>.handle');
    if(!h){
      h = document.createElement('div'); h.className='handle'; sel.appendChild(h);
      h.addEventListener('pointerdown', (ev)=>{
        ev.preventDefault(); ev.stopPropagation();
        const sx=ev.clientX, sy=ev.clientY, sw=sel.offsetWidth, sh=sel.offsetHeight;
        sel.setPointerCapture(ev.pointerId);
        function mv(e){ const w = Math.max(20, sw + (e.clientX - sx)); const h = Math.max(20, sh + (e.clientY - sy)); sel.style.width = snap(w)+'px'; sel.style.height = snap(h)+'px'; }
        function up(){ sel.releasePointerCapture(ev.pointerId); sel.removeEventListener('pointermove', mv); sel.removeEventListener('pointerup', up); }
        sel.addEventListener('pointermove', mv); sel.addEventListener('pointerup', up);
      });
    }
  }

  function bindDrag(el){
    el.style.touchAction='none';
    el.addEventListener('pointerdown', (ev)=>{
      if(!editing) return;
      ev.preventDefault();
      select(el);
      const sx=ev.clientX, sy=ev.clientY, sl=el.offsetLeft, st=el.offsetTop;
      el.setPointerCapture(ev.pointerId);
      function mv(e){
        const nx = clamp(snap(sl + (e.clientX - sx)), 0, stage.clientWidth - el.offsetWidth);
        const ny = clamp(snap(st + (e.clientY - sy)), 0, stage.clientHeight - el.offsetHeight);
        el.style.left = nx+'px'; el.style.top = ny+'px';
      }
      function up(){ el.releasePointerCapture(ev.pointerId); el.removeEventListener('pointermove', mv); el.removeEventListener('pointerup', up); }
      el.addEventListener('pointermove', mv); el.addEventListener('pointerup', up);
    });
    el.addEventListener('click', ()=> select(el));
  }

  function add(kind, data={}){
    const id = data.id || (()=>{ let i=1; while(document.getElementById('el-'+kind+'-'+i)) i++; return 'el-'+kind+'-'+i; })();
    let el;
    if(kind==='goal'){
      el = document.createElement('div'); el.className='element goalbar'; el.id=id; el.dataset.kind='goal'; el.dataset.value=String(data.value||0); el.dataset.max=String(data.max||100);
      const fill = document.createElement('div'); fill.className='fill'; const label=document.createElement('div'); label.className='label'; el.appendChild(fill); el.appendChild(label); const pct = Math.max(0, Math.min(1, (data.value||0)/Math.max(1,(data.max||100)))); fill.style.width = (pct*100)+'%'; label.textContent = `${data.value||0} / ${data.max||100}`;
    } else if(kind==='pill'){
      el = document.createElement('div'); el.className='element pill'; el.id=id; el.dataset.kind='pill'; el.textContent=data.text||'Pill';
    } else if(kind==='ring'){
      el = document.createElement('div'); el.className='element ring'; el.id=id; el.dataset.kind='ring'; el.dataset.value=String(data.value||0); el.dataset.max=String(data.max||100);
      const arc=document.createElement('div'); arc.className='arc'; const label=document.createElement('div'); label.className='label'; const max=Math.max(1,data.max||100); const pct=Math.round(100*(data.value||0)/max); arc.style.setProperty('--p', pct+'%'); label.textContent=pct+'%'; el.appendChild(arc); el.appendChild(label);
    } else if(kind==='ticker'){
      el = document.createElement('div'); el.className='element ticker'; el.id=id; el.dataset.kind='ticker'; el.style.background='transparent'; el.style.border='none'; el.style.boxShadow='none'; el.textContent=data.text||'Welcome to the stream Â· '; el.style.setProperty('--spd', (data.speed||20)+'s');
    } else if(kind==='alert'){
      el = document.createElement('div'); el.className='element alert'; el.id=id; el.dataset.kind='alert'; el.textContent=data.text||'New tip!';
    } else if(kind==='countdown'){
      el = document.createElement('div'); el.className='element countdown'; el.id=id; el.dataset.kind='countdown'; el.dataset.until=String(data.until||''); el.textContent='00:00';
    } else if(kind==='image' && data.src){
      el = document.createElement('div'); el.className='element'; el.id=id; el.dataset.kind='image'; const img=document.createElement('img'); img.src=data.src; img.style.maxWidth='100%'; img.style.maxHeight='100%'; img.style.display='block'; el.appendChild(img); el.style.background='transparent';
    } else {
      el = document.createElement('div'); el.className='element'; el.id=id; el.dataset.kind='text'; el.textContent=data.text||'Text';
    }
    el.style.left=(data.left??40)+'px'; el.style.top=(data.top??40)+'px'; el.style.width=(data.width??300)+'px'; el.style.height=(data.height??80)+'px';
    if(data.styles){ const s=data.styles; if(s.bg) el.style.background=s.bg; if(s.color) el.style.color=s.color; if(s.radius) el.style.borderRadius=s.radius; if(s.boxShadow) el.style.boxShadow=s.boxShadow; if(s.fontSize) el.style.fontSize=s.fontSize; if(s.fontWeight) el.style.fontWeight=s.fontWeight; if(s.align) el.style.textAlign=s.align; }
    canvas.appendChild(el); bindDrag(el); select(el);
    return el;
  }

  function layoutJSON(){
    return Array.from(canvas.children).map(el => ({
      id: el.id, left: el.offsetLeft, top: el.offsetTop, width: el.offsetWidth, height: el.offsetHeight,
      kind: el.dataset.kind||'text', value:+(el.dataset.value||0), max:+(el.dataset.max||100),
      styles: { bg:el.style.background||null, color:el.style.color||null, radius:el.style.borderRadius||null, boxShadow:el.style.boxShadow||null, fontSize:el.style.fontSize||null, fontWeight:el.style.fontWeight||null, align:el.style.textAlign||null },
      text: (el.dataset.kind==='text'||el.classList.contains('pill')) ? el.textContent : undefined
    }));
  }

  async function save(){
    const data = JSON.stringify(layoutJSON());
    try{ await fetch('/api/layout',{method:'POST',headers:{'Content-Type':'application/json'},body:data}); }
    catch(e){ localStorage.setItem('buttcaster-layout', data); }
  }

  async function load(){
    try{ const r=await fetch('/api/layout'); if(r.ok){ const j=await r.json(); canvas.innerHTML=''; j.forEach(o=>add(o.kind,o)); return; } }catch(e){}
    const s=localStorage.getItem('buttcaster-layout'); if(s){ canvas.innerHTML=''; try{ JSON.parse(s).forEach(o=>add(o.kind,o)); }catch(e){} }
  }

  window.addEventListener('message', (e)=>{
    const d = e.data || {};
    if(d.type==='editor:grid'){ grid.style.display = d.on ? 'block':'none'; }
    else if(d.type==='editor:snap'){ GRID = Math.max(1, +d.size||20); }
    else if(d.type==='editor:lock'){ editing = !d.lock; }
    else if(d.type==='editor:add'){ add(d.kind||'text', d); }
    else if(d.type==='editor:dup' && sel){ const c=sel.cloneNode(true); c.id=sel.id+'-copy-'+Math.floor(Math.random()*9999); canvas.appendChild(c); bindDrag(c); }
    else if(d.type==='editor:del' && sel){ sel.remove(); sel=null; }
    else if(d.type==='editor:undo'){ /* simple version omitted for stability */ }
    else if(d.type==='editor:redo'){ /* simple version omitted for stability */ }
    else if(d.type==='editor:save'){ save(); }
    else if(d.type==='editor:load'){ load(); }
    else if(d.type==='editor:set' && d.id){ const el=document.getElementById(d.id); if(!el) return; const v=d.values||{};
      if('left' in v) el.style.left=(v.left||0)+'px';
      if('top' in v) el.style.top=(v.top||0)+'px';
      if('width' in v) el.style.width=(v.width||el.offsetWidth)+'px';
      if('height' in v) el.style.height=(v.height||el.offsetHeight)+'px';
      if('z' in v) el.style.zIndex=String(v.z||0);
      if('rotate' in v){ el.dataset.rotate=String(v.rotate||0); el.style.transform='rotate('+el.dataset.rotate+'deg)'; }
      if('opacity' in v) el.style.opacity=String(Math.max(0,Math.min(1,v.opacity)));
      if(el.classList.contains('goalbar')){ if('value' in v) el.dataset.value=String(v.value); if('max' in v) el.dataset.max=String(v.max); const fill=el.querySelector('.fill'); const label=el.querySelector('.label'); const pct=Math.max(0,Math.min(1,(+el.dataset.value)/Math.max(1,+el.dataset.max))); if(fill) fill.style.width=(pct*100)+'%'; if(label) label.textContent=`${el.dataset.value} / ${el.dataset.max}`; }
      if(el.dataset.kind==='text' && 'text' in v) el.textContent=String(v.text);
      if('bg' in v) el.style.background=v.bg;
      if('radius' in v) el.style.borderRadius=String(v.radius)+'px';
      if('shadow' in v) el.style.boxShadow=`0 10px ${Math.max(0,Number(v.shadow)||0)}px rgba(0,0,0,.25)`;
      if('fontSize' in v) el.style.fontSize=String(v.fontSize)+'px';
      if('fontWeight' in v) el.style.fontWeight=String(v.fontWeight);
      if('textColor' in v){ el.style.color=v.textColor; const lab=el.querySelector('.label'); if(lab) lab.style.color=v.textColor; }
      if('align' in v) el.style.textAlign=String(v.align);
      if(v.gradStart || v.gradEnd){ const a=v.gradStart||'#ff7ac8', b=v.gradEnd||'#9ad8ff'; if(el.classList.contains('goalbar')){ const fill=el.querySelector('.fill'); if(fill) fill.style.background=`linear-gradient(90deg, ${a}, ${b})`; } if(el.classList.contains('pill')){ el.style.background=`linear-gradient(90deg, ${a}, ${b})`; } if(el.dataset.kind==='ring'){ const arc=el.querySelector('.arc'); if(arc) arc.style.background=`conic-gradient(${a} var(--p,0%), ${b} 0)`; } }
    }
  });

  // seed
  (function seed(){
    const t = add('text',{id:'el-title', left:40, top:40, width:320, height:80, text:'ButtCaster Overlay'});
    const g = add('goal',{id:'el-goal', left:40, top:140, width:320, height:80, value:0, max:100});
  })();
})();
</script>
</body>
</html>
