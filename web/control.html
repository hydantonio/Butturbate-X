
<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Butturbate X — Control</title>
<link rel="stylesheet" href="/css/brand.css">
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/click-force.css">
<style>
  .element > * { pointer-events: none; }
  .stage { background:#0b0f19; }
  .stage-wrap { user-select: none; }
  .sel { display:none; }
</style>
<script src="/socket.io/socket.io.js"></script>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <div class="logo"><img src="/img/logo.svg" height="28"><div style="font-weight:800">Butturbate X</div></div>
    <div class="navbtn active" data-section="overlay">Overlay</div>
    <div class="navbtn" data-section="mappings">Mappings</div>
    <div class="navbtn" data-section="devices">Devices</div>
    <div class="navbtn" data-section="settings">Settings</div>
  </div>

  <div class="center">
    <div class="top">
      <div class="chip">Intiface: <span id="st">disconnected</span></div>
      <div class="chip">Devices: <span data-devices-count>0</span></div>
      <!-- Replaced: button now does Tip test 50 -->
      <button id="tip50" style="margin-left:auto">Tip test 50</button>
    </div>
    <div class="canvas">
      <div class="stage-wrap"><div class="stage" id="stage">
        <div class="grid"></div>
        <div class="glow"></div>
        <div class="canvas-abs" id="canvas" style="position:absolute;inset:0;transform-origin:0 0">
          <div id="sel" class="sel">
            <div class="h nw"></div><div class="h n"></div><div class="h ne"></div>
            <div class="h w"></div><div class="h e"></div>
            <div class="h sw"></div><div class="h s"></div><div class="h se"></div>
          </div>
        </div>
        <img class="watermark" src="/img/watermark.svg" id="wm" width="160">
      </div></div>

      <div id="view-overlay" class="view section">
        <div class="row">
          <label>Goal target<br><input id="goal" type="number" value="2000" style="width:140px"></label>
          <label><input type="checkbox" id="wmChk" checked> Watermark</label>
          <label><input type="checkbox" id="glowChk" checked> Lights</label>
          <button id="save">Save</button>
        </div>
        <div class="toolbar">
          <button id="addText">Add Text</button>
          <button id="addGoal">Add Tip Goal</button>
          <button id="addImage">Add Image</button>
          <button id="emit">Emit Tip 100</button>
        </div>
      </div>

      <div id="view-mappings" class="view section" hidden>
        <div><strong>Mappings (token → intensity/duration)</strong></div>
        <div id="maps">
          <div class="hdr">Min</div><div class="hdr">Max</div><div class="hdr">Intensity</div><div class="hdr">Duration (ms)</div><div></div>
        </div>
        <div class="row"><button id="addRange">Add Range</button><button id="clearRanges">Clear</button></div>
      </div>

      <div id="view-devices" class="view section" hidden>
        <div class="row">
          <label>WS URL<br><input data-intiface-url id="ws" value="ws://127.0.0.1:12345" style="width:240px"></label>
          <button data-intiface-connect id="btnConn">Connect Intiface</button>
          <button data-vibrate-test id="vibrateTest">Vibrate test</button>
        </div>
        <div id="devList" class="list" style="margin-top:12px"></div>
      </div>

      <div id="view-settings" class="view section" hidden>
        <div class="row">
          <label>Haptics Preset<br><select id="preset"><option value="gentle">Gentle</option><option value="balanced" selected>Balanced</option><option value="intense">Intense</option></select></label>
          <button id="goalR">Goal Reached</button>
          <button id="quit">Quit</button>
        </div>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="section">
      <div style="font-weight:900">Properties</div>
      <div id="noSel" style="opacity:.65">Select an element to edit.</div>
      <div id="propPane" style="display:none">
        <label>Text<input id="p_text"></label>
        <div class="row">
          <label style="flex:1">Font<select id="p_font"><option value="Calibri">Calibri</option><option value="Inter">Inter</option><option value="Segoe UI">Segoe UI</option></select></label>
          <label style="width:100px">Size<input id="p_size" type="number" value="36"></label>
        </div>
        <div class="row">
          <label style="flex:1">Color<input id="p_color" type="color" value="#0a0d14"></label>
          <label style="flex:1">Width<input id="p_w" type="number"></label>
          <label style="flex:1">Height<input id="p_h" type="number"></label>
        </div>
        <div class="row">
          <button id="front">Front</button><button id="back">Back</button>
          <button id="dup">Duplicate</button><button id="del">Delete</button>
        </div>
      </div>
    </div>
    <div class="section">
      <div style="font-weight:900">Layers</div>
      <ol id="layers"></ol>
    </div>
  </div>
</div>

<script>
// expose socket for intiface.js
window.__io_socket = io();
const socket = window.__io_socket;
document.getElementById('tip50').onclick = () => socket.emit('tip', {amount:50, user:'Test'});

const stage = document.getElementById('stage'),
      canvas = document.getElementById('canvas'),
      sel = document.getElementById('sel'),
      wm = document.getElementById('wm'),
      glow = document.querySelector('.glow');
let settings = { showWatermark:true, glow:true, goalTarget:2000, goalValue:0 };
let elements = [];
let mappings = [];
let selected = null;

function scale(){
  const s = Math.min((window.innerWidth - 240 - 340 - 32) / 1920, 0.5);
  document.querySelector('.canvas-abs').style.transform = 'scale('+s+')';
}
scale(); addEventListener('resize', scale);

function px(n){return (n|0)+'px'}

function render(){
  // Prevent phantom goalbar: render only existing elements
  canvas.querySelectorAll('.element').forEach(n=>n.remove());
  const L = document.getElementById('layers'); if(L) L.innerHTML='';
  for(const el of elements){
    const node=document.createElement('div');
    node.className='element'; node.dataset.id=el.id;
    node.style.left=px(el.x); node.style.top=px(el.y);
    node.style.width=px(el.w||600); node.style.height=px(el.h||60);
    node.style.pointerEvents='auto';

    if(el.type==='goalbar'){
      const track=document.createElement('div'); track.className='goal'; track.style.position='absolute'; track.style.inset='0'; track.style.pointerEvents='none';
      const lab=document.createElement('div'); lab.className='label'; lab.textContent=`Remaining: ${Math.max(0,(settings.goalTarget||0)-(settings.goalValue||0))}`; lab.style.pointerEvents='none';
      node.appendChild(track); node.appendChild(lab);
    }else if(el.type==='text'){
      node.style.fontWeight='800'; node.style.fontSize=px(el.size||48); node.textContent=el.text||'TEXT';
    }else if(el.type==='image'){
      node.style.background='#e9edf3'; node.style.borderRadius='12px'; node.innerHTML='<div class="label">Image</div>';
    }

    node.addEventListener('click',()=>select(el.id));
    node.addEventListener('pointerdown', dragStart(el, node));
    canvas.appendChild(node);

    if(L){ const li=document.createElement('li'); li.textContent=`${el.type} — ${el.id}`; li.onclick=()=>select(el.id); L.appendChild(li); }
  }
  canvas.appendChild(sel);
  if(wm) wm.style.display=settings.showWatermark?'block':'none';
  if(glow) glow.style.display=settings.glow?'block':'none';
  if(selected){ showSel(); } else { sel.style.display='none'; }
}

function select(id){ selected=id; openProps(); showSel(); }
function showSel(){
  const el=elements.find(e=>e.id===selected); if(!el) return;
  sel.style.display='block'; sel.style.left=px(el.x); sel.style.top=px(el.y);
  sel.style.width=px(el.w||600); sel.style.height=px(el.h||60);
  sel.querySelectorAll('.h').forEach(h=>attachResize(h,el,[...h.classList].pop()));
}

function canvasScale(){
  const rect = canvas.getBoundingClientRect();
  const sc = rect.width / 1920;
  return {rect, sc};
}

function attachResize(h,el,k){
  h.onpointerdown=e=>{ h.setPointerCapture(e.pointerId);
    const {rect, sc} = canvasScale();
    const start={x:e.clientX,y:e.clientY,ex:el.x,ey:el.y,ew:el.w||600,eh:el.h||60};
    function mv(ev){ const dx=(ev.clientX-start.x)/sc, dy=(ev.clientY-start.y)/sc;
      let x=el.x,y=el.y,w=el.w||600,h=el.h||60;
      if(k.includes('e')) w=Math.max(20,Math.round(start.ew+dx));
      if(k.includes('s')) h=Math.max(20,Math.round(start.eh+dy));
      if(k.includes('w')){ x=Math.round(start.ex+dx); w=Math.max(20,Math.round(start.ew-dx)); }
      if(k.includes('n')){ y=Math.round(start.ey+dy); h=Math.max(20,Math.round(start.eh-dy)); }
      Object.assign(el,{x,y,w,h}); socket.emit('element:update',el);
    }
    function up(){ h.releasePointerCapture(e.pointerId); removeEventListener('pointermove',mv); removeEventListener('pointerup',up); render(); }
    addEventListener('pointermove',mv,{passive:true}); addEventListener('pointerup',up,{once:true});
  };
}

function dragStart(el,node){ return e=>{ if(e.button!==0)return; node.setPointerCapture?.(e.pointerId);
  const {rect, sc} = canvasScale();
  const start={x:e.clientX,y:e.clientY,ex:el.x,ey:el.y};
  node.onpointermove=ev=>{ const dx=(ev.clientX-start.x)/sc, dy=(ev.clientY-start.y)/sc;
    el.x=Math.round(start.ex+dx); el.y=Math.round(start.ey+dy); socket.emit('element:update',el); showSel(); };
  node.onpointerup=()=>{ node.onpointermove=null; };
};}

// Toolbar
document.getElementById('addText').onclick=()=>socket.emit('element:add',{id:String(Date.now()),type:'text',text:'WELCOME',x:360,y:320,size:64,w:800,h:72});
document.getElementById('addGoal').onclick=()=>{ if(!elements.find(e=>e.type==='goalbar')) socket.emit('element:add',{id:'goalbar-1',type:'goalbar',x:280,y:120,w:960,h:100}); };
document.getElementById('addImage').onclick=()=>socket.emit('element:add',{id:String(Date.now()),type:'image',x:80,y:380,w:200,h:140});
document.getElementById('emit').onclick=()=>socket.emit('tip',{amount:100,user:'Tester'});
document.getElementById('save').onclick=()=>{ socket.emit('settings:update',{showWatermark:document.getElementById('wmChk').checked,glow:document.getElementById('glowChk').checked}); socket.emit('goal:set',Number(document.getElementById('goal').value)||0); };
document.getElementById('goalR').onclick=()=>socket.emit('overlay:goal-reached',{});
document.getElementById('quit').onclick=()=>fetch('/app/quit').catch(()=>{});

// Mappings UI
function renderMappings(){
  const root=document.getElementById('maps'); if(!root) return;
  root.querySelectorAll('.rowItem').forEach(n=>n.remove());
  mappings.forEach((m,idx)=>{
    const min=document.createElement('input'); min.type='number'; min.value=m.min||0; min.oninput=e=>{ m.min=Number(e.target.value)||0; pushMappings(); };
    const max=document.createElement('input'); max.type='number'; max.value=m.max||0; max.oninput=e=>{ m.max=Number(e.target.value)||0; pushMappings(); };
    const inten=document.createElement('input'); inten.type='number'; inten.value=m.intensity||50; inten.min=0; inten.max=100; inten.oninput=e=>{ m.intensity=Math.max(0,Math.min(100,Number(e.target.value)||0)); pushMappings(); };
    const dur=document.createElement('input'); dur.type='number'; dur.value=m.duration||800; dur.min=50; dur.step=50; dur.oninput=e=>{ m.duration=Math.max(50,Number(e.target.value)||800); pushMappings(); };
    const rm=document.createElement('button'); rm.textContent='Remove'; rm.className='rm'; rm.onclick=()=>{ mappings.splice(idx,1); renderMappings(); pushMappings(); };
    [min,max,inten,dur,rm].forEach(el=>{ el.classList.add('rowItem'); root.appendChild(el); });
  });
}
function pushMappings(){ socket.emit('mappings:set', mappings); }
document.getElementById('addRange').onclick=()=>{ mappings.push({min:1,max:50,intensity:40,duration:800}); renderMappings(); pushMappings(); };
document.getElementById('clearRanges').onclick=()=>{ mappings=[]; renderMappings(); pushMappings(); };

// Sockets
socket.on('overlay:settings', s=>{ settings={...settings,...s}; document.getElementById('wmChk').checked=!!settings.showWatermark; document.getElementById('glowChk').checked=!!settings.glow; document.getElementById('goal').value=settings.goalTarget||2000; render(); });
socket.on('overlay:elements', list=>{ elements=list||[]; render(); });
socket.on('overlay:goal', g=>{ settings.goalValue=g.current; settings.goalTarget=g.target; render(); });
socket.on('mappings', list=>{ mappings = Array.isArray(list)? list : []; renderMappings(); });

// Initial
socket.emit('elements:get');
socket.emit('mappings:get');

// Drag & drop images
const hl = document.createElement('div'); hl.style.cssText='position:absolute;inset:0;border:2px dashed #7eb5ff;border-radius:16px;display:none;pointer-events:none';
stage.appendChild(hl);
stage.addEventListener('dragover', e=>{ e.preventDefault(); hl.style.display='block'; });
stage.addEventListener('dragleave', e=>{ e.preventDefault(); hl.style.display='none'; });
stage.addEventListener('drop', e=>{ e.preventDefault(); hl.style.display='none';
  for(const file of e.dataTransfer.files){ if(file.type.startsWith('image/')){ const r=new FileReader(); r.onload=()=>{
    const rect = canvas.getBoundingClientRect(); const sc = rect.width/1920;
    const x = Math.round((e.clientX - rect.left)/sc)-120; const y = Math.round((e.clientY - rect.top)/sc)-90;
    socket.emit('element:add',{id:String(Date.now()),type:'image',src:r.result,x:Math.max(0,x),y:Math.max(0,y),w:240,h:180});
  }; r.readAsDataURL(file);} }
});
</script>

<script type="module" src="/js/intiface.js"></script>
<script src="/js/click-force.js"></script>
</body></html>
